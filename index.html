<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- The main application UI will be rendered here -->
    <div id="app">
        <h1 class="text-center text-2xl font-bold text-gray-500 mt-20">Loading Job Tracker...</h1>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import necessary functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. INITIAL SETUP & CONFIGURATION (JT-1) ---

        // These global variables are provided by the environment.
        // DO NOT replace them with actual values.
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Initialize the Firebase app
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log("Firebase App Initialized.");

        // --- 3. AUTHENTICATION ---
        
        // Sign in the user. This is required to have permission to read/write to the database.
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                 await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                 await signInAnonymously(auth);
            }
            console.log("User signed in with UID:", auth.currentUser.uid);
        } catch (error) {
            console.error("Authentication Error:", error);
            document.getElementById('app').innerHTML = `<div class="text-center text-red-500">Authentication Failed. Please refresh.</div>`;
        }

        // --- 2. DATABASE SCHEMA DEFINITION ---
        
        // This section defines the structure of our data.
        // The 'jobs' collection will hold all our job application documents.
        // Each document will have the following fields:
        // {
        //   company: "string",
        //   title: "string",
        //   url: "string",
        //   date: "timestamp", // The date the application was submitted
        //   status: "string", // e.g., "Wishlist", "Applied"
        //   otherInfo: "string",
        //   createdAt: "timestamp" // To know when the entry was created
        // }
        const jobsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'jobs');

        // --- 3. BACKEND API: ADD A JOB ---
        
        /**
         * Creates a new job document in Firestore.
         * @param {object} jobData - The data for the new job.
         * @returns {string} The ID of the newly created job document.
         */
         async function addJob(jobData) {
            try {
                // Create a new document reference with a unique ID
                const newJobRef = doc(jobsCollectionRef);
                
                // Add the createdAt timestamp and ID to the job data
                const finalJobData = {
                    ...jobData,
                    id: newJobRef.id,
                    createdAt: serverTimestamp()
                };

                // Set the document with the new data
                await setDoc(newJobRef, finalJobData);

                console.log("Successfully added job with ID:", newJobRef.id);
                return newJobRef.id;

            } catch (error) {
                console.error("Error adding job:", error);
                return null;
            }
        }

        // --- TEST CODE ---
        // This section demonstrates how to use the addJob function.
        
        async function testAddJob() {
            console.log("Running a test to add a new job...");
            const testJob = {
                company: "Test Company",
                title: "Backend Developer",
                url: "https://testcompany.com",
                date: new Date(),
                status: "Wishlist",
                otherInfo: "This is a test entry from testAddJob function."
            };
            const newId = await addJob(testJob);
            if (newId) {
                console.log(`Test successful! New job created with ID: ${newId}. Check your Firestore console.`);
            } else {
                console.log("Test failed. See error above.");
            }
        }

        // Uncomment the line below to test the function.
        if (userId) { 
             // testAddJob(); 
        }

    </script>

</body>
</html>
